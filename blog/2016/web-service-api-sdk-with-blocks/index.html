<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Oliver Young</title>
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet">
  <link rel="stylesheet" href="/markdown.css">
<style type="text/css">
body {
  margin: 0;
}
#app {
  margin: 0 auto;
}
#social-media {
  margin: 6px;
  float: right;
}
#header {
  margin: 80px auto;
  text-align: center;
  font-family: -apple-system, 'Helvetica Neue';
}
#header h1 {
  font-size: 38px;
  color: #333333;
  font-weight: bold;
  letter-spacing: normal;
}
#header p {
  font-size: 22px;
  color: #A9A9A9;
  -webkit-font-smoothing: antialiased;
}
.divider {
  height: 1px;
  background-color: #E6E6E6;
}
#post-list {
  max-width: 700px;
  margin: 80px auto;
  padding: 0;
}
#post-list li {
  list-style: none;
}
</style><style type="text/css">
.post-list h1 {
  font-size: 20px;
  font-weight: bold;
  letter-spacing: normal;
  margin: 0;
}
.post-list a {
  color: #333;
  text-decoration: none;
}
.post-list a:hover {
  text-decoration: underline;
}
.post-list .date, .post-list .category-and-tags {
  font-size: 12px;
  color: #9E9E9E;
}
.post-list .summary {
  font-size: 14px;
  line-height: 24px;
  color: #333;   
  overflow-wrap: break-word;
}
.post-list-divider {
    margin: 30px auto;
}
</style><style type="text/css">
.entry-title, .entry-meta, .content {
    margin-left: auto;
    margin-right: auto;
    max-width: 700px;
    padding-left: 18px;
    padding-right: 18px;
}
.content {
  margin-top: 60px;
}
.entry-title {
  -webkit-font-smoothing: antialiased;
  margin-top: .42em;
  margin-bottom: .7em;
  letter-spacing: .02em;
  line-height: 1.1;
  color: white;
  font-size: 40px;
  font-weight: 800;
}
.entry-meta {
  font-size: 14px;
  color: rgba(0, 0, 0, .5);
  font-family: Helvetica Neue, sans-serif;
  font-weight: 500;
}
.content img {
  max-width: 100%;
  display: block;
  margin: auto;
}
pre {
  padding: 10px;
  overflow: auto;
  border: #E3EDF3 1px solid;
  background: #F7FAFB;
}
.banner {
  padding: 160px 0;
  text-align: center;
  background: linear-gradient(to bottom, #545454, #bdbdbd);
}
.content > p:first-child::first-letter {
    float:  left;
    font-size: 56px;
    line-height:  .83;
    padding-top: 3px;
    padding-right: 6px;
    font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    font-weight: bold;
}
</style><style type="text/css">
#nav a {
  text-decoration: none;
}
#nav {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 55px;
  margin: 0 28px;
  display: flex;
  align-items: center;
  font-size: 13px;
  font-family: Helvetica, sans-serif;
  font-weight: bold;
  color: rgba(0, 0, 0, .48);
  border-bottom: 1px solid rgba(0, 0, 0, .05);
}
#nav::after {
  height: 1px;
  color: rgba(0, 0, 0, .05);
}
.nav-left, .nav-right {
  flex: 1;
  display: flex;
}
.nav-right {
  justify-content: flex-end;
}
.nav-left > .nav-item {
  padding-right: 12px;
}
.nav-right > .nav-item {
  padding-left: 12px;
}
#social-media a {
  font-family: -apple-system;
  color: #8B572A;
}
#social-media a:hover {
  color: #733F10;
}
</style><style type="text/css">
textarea {
  width: 100%;
  height: 400px;
}
.h1 {
  font-size: 24px;
}
</style><style type="text/css">
#app {
  /* max-width: 1080px; */
  margin: 0 auto;
}
#social-media {
  margin: 6px;
  float: right;
}
#header {
  margin: 80px auto;
  text-align: center;
  font-family: -apple-system, 'Helvetica Neue';
}
#header h1 {
  font-size: 38px;
  color: #333333;
}
#header p {
  font-size: 22px;
  color: #A9A9A9;
  -webkit-font-smoothing: antialiased;
}
.divider {
  height: 1px;
  background-color: #E6E6E6;
}
#post-list {
  max-width: 700px;
  margin: 80px auto;
  padding: 0;
}
#post-list li {
  list-style: none;
}
.write-button-container {
  max-width: 700px;
  margin: 0 auto;
  margin-top: 60px;
  text-align: right;
}
.button {
  padding: 8px 16px;
  border: 1px solid rgba(0, 0, 0, .25);
  border-radius: 4px;
  text-decoration: none;
  color: rgba(0, 0, 0, .25);
  font-family: sans-serif;
  font-size: 14px;
}
.button:hover {
  border: 1px solid rgba(0, 0, 0, .45);
  color: rgba(0, 0, 0, .45);
}
</style><style type="text/css">
input, textarea {
  border: none;
}
textarea {
  height: 50px;
}
.title {
  font-size: 20px;
  font-weight: bold;
}
.post-list a:hover {
  text-decoration: underline;
}
.post-list .date, .post-list .category-and-tags {
  font-size: 12px;
  color: #9E9E9E;
}
.post-list .summary {
  font-size: 14px;
  line-height: 24px;
  color: #333;   
  overflow-wrap: break-word;
}
.post-list-divider {
    margin: 30px auto;
}
.operation {
  cursor: pointer;
}
</style><style type="text/css">
.coming-soon {
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 44px;
    font-weight: bold;
}
</style></head>
<body>
    <div id="app"><div id="nav"><div class="nav-left"><div class="nav-item"><a href="/blog" class="router-link-active">BLOG</a></div> <div class="nav-item"><a href="/projects" class="">PROJECTS</a></div></div> <div><a href="/" class="router-link-active"><img height="26" id="logo" src="/logo.svg"></a></div> <div class="nav-right"><div class="nav-item"><a href="/about" class="">ABOUT</a></div> <div class="nav-item"><a href="/hire-me" class="">HIRE ME</a></div></div></div> <div class="view fade-enter fade-enter-active"><div class="banner"><h1 class="entry-title">使用Blocks封装Web Service API</h1> <div class="entry-meta">Feb 04, 2016 #iOS #Objective-C #Blocks #Swift #Closures</div></div> <div class="content"><p>《嘻嘻圈》作为一款互联网应用，涉及到许多网络操作。在开发初期，为了追求进度，简单粗暴的在需要的时候发起连接请求。这样一来，造成了很多重复代码。这个问题在我开始写相关代码的时候就意识到了。我之所以迟迟没有优化是因为网络操作都是异步的，需要等待处理结果，然后根据结果写相关代码。重复或者说需要优化的代码在外部，自定义代码在回调结果里，使用一般的代码优化办法不可行。当时我就在想我的自定义代码如果可以作为一个函数的参数就好了，这样就可以成功地优化代码了。那时候我还不知道怎么办，直到最近几天读到objective-c中block的相关内容时，我才恍然大悟，block不就是我期盼的东西吗!</p>
<!--more-->
<p>举个例子，我可能需要像下面这样使用<code>NSURLSession</code>发起多个Get请求，我之前的做法是在每个需要发起Get请求的地方都复制一份以下的代码，只不过将url和completionHandler的实现替换成实际的需求。</p>
<pre><code class="lang-objc">NSURL *URL = [NSURL URLWithString:@"http://movier.me"]; //重复代码，只不过url不同
NSURLRequest *request = [NSURLRequest requestWithURL:URL]; // 重复代码
NSURLSessionDataTask *task = [[NSURLSession sharedSession] dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) { // 重复代码
    /* 以下这些代码可能会不同
    if (error) {
        return;
    }
    NSString *html = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
    [self.webView loadHTMLString:html baseURL:URL];
     */
}];
[task resume]; // 重复代码
</code></pre>
<p>这样做显然会造成许多重复的代码，如果能把completionHandler中的代码片段当成一个参数传人我们提炼的方法中的话，就能成功地优化代码了。而<code>Blocks</code>正是实现这个功能的完美解决方案。</p>
<p><strong>What's Blocks?</strong></p>
<blockquote>
<p>Blocks are a language-level feature added to C, Objective-C and C++, which allow you to create distinct segments of code that can be passed around to methods or functions as if they were values.</p>
<p>Blocks是加入到C、Objective-C和C++语言层面的特点，它允许你创建不同的代码片段，而这些代码片段可以作为参数传递给方法或者函数就好像他们是数值一样。</p>
</blockquote>
<p><strong>使用Blocks解决上述问题</strong></p>
<p>首先，定义方法：</p>
<pre><code class="lang-objc">- (void)methodNameUrl:(NSString *)url callback:(void (^)(NSData *, NSError *))callback;
</code></pre>
<p>其次，实现该方法：</p>
<pre><code class="lang-objc">- (void)methodNameUrl:(NSString *)url callback:(void (^)(NSData *, NSError *))callback {
  NSURL *URL = [NSURL URLWithString:url];
  NSURLRequest *request = [NSURLRequest requestWithURL:URL];
  NSURLSessionDataTask *task = [[NSURLSession sharedSession] dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
    callback(data, error);
  }];
  [task resume];
}
</code></pre>
<p>最后，只要在需要的地方调用该方法并传入相应参数即可：</p>
<pre><code class="lang-objc">[id methodNameUrl:@"http://movier.me" callback:^(NSData *data, NSError *error) {
  // Do whatever you want to do
  if (error) {
      return;
  }
  NSString *html = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
  [self.webView loadHTMLString:html baseURL:URL];
}];
</code></pre>
<p>这样一来，我们就成功地使用Blocks优化了代码。其实，除了Objective-C之外，其他语言也有类似特性，譬如Swift的Closures，Java 8中的Lambdas等。</p>
<p><strong>接下去，我们尝试使用Swift的Closures实现上述需求</strong></p>
<p>首先，还是定义方法：</p>
<pre><code class="lang-swift">func methodNameUrl(url: String, completionClosure: (data: NSData?, error: NSError?) -&gt; ()) {
    let url = NSURL(string: url)
    let request = NSURLRequest(URL: url!)
    let task = NSURLSession.sharedSession().dataTaskWithRequest(request, completionHandler: {(data, response, error) in
      completionClosure(data: data, error: error)
    })
    task.resume()
}
</code></pre>
<p>然后，调用该方法并传入相应参数即可：</p>
<pre><code>methodNameUrl("http://httpbin.org/get") { (data, error) -&gt; () in
    // Do something with data or error
}
</code></pre><p>至此，我们分别使用Objective-C的Blocks和Swift的Closures封装了Web Service API。</p>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="https://www.gitbook.com/book/zonble/kkbox-ios-dev/details">KKBOX iOS/Mac OS X 基本開發教材</a>中关于Blocks的章节</li>
<li>感谢<a href="http://httpbin.org">httpbin</a>提供的免费调试服务</li>
</ul>
</div> <input type="hidden" id="loaded-signal"></div> <p class="copyright">Copyright © 2017 MOVIER.ME - All Rights Reserved.</p></div>
  


</body></html>