<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Oliver Young</title>
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet">
  <style>
    .copyright {
      text-align: center;
      font-size: 12px;
      color: #C8C8C8;
    }
    body {
      font: 400 16px/1.42 -apple-system, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei, sans-serif;
      color: rgba(7, 5, 5, 0.86);
    }
  </style>
<style type="text/css">
#app {
  max-width: 1080px;
  margin: 0 auto;
}
#nav {
}
#social-media {
  margin: 6px;
  float: right;
}
#logo {
  
  height: 42px;
}
#header {
  margin: 80px auto;
  text-align: center;
  font-family: -apple-system, 'Helvetica Neue';
}
#header h1 {
  font-size: 38px;
  color: #333333;
}
#header p {
  font-size: 22px;
  color: #A9A9A9;
  -webkit-font-smoothing: antialiased;
}
.divider {
  height: 1px;
  background-color: #E6E6E6;
}
#post-list {
  max-width: 700px;
  margin: 80px auto;
  padding: 0;
}
#post-list li {
  list-style: none;
}
</style><style type="text/css">
















/* .post-list {
  font-family: -apple-system, "Hiragino Sans GB", sans-serif;
} */
.post-list h1 {
  font-size: 20px;
}
.post-list a {
  color: #333;
  text-decoration: none;
}
.post-list a:hover {
  text-decoration: underline;
}
.post-list .date, .post-list .category-and-tags {
  font-size: 12px;
  color: #9E9E9E;
}
.post-list .summary {
  font-size: 14px;
  line-height: 24px;
  color: #333;   
  overflow-wrap: break-word;
}
.post-list-divider {
    margin: 30px auto;
}
</style><style type="text/css">
.entry-title, .entry-meta, .content {
    margin-left: auto;
    margin-right: auto;
    max-width: 700px;
    padding-left: 18px;
    padding-right: 18px;
}
.entry-title {
  -webkit-font-smoothing: antialiased;
  font-size: 2.2em;
  font-weight: 900;
  margin-top: .42em;
  margin-bottom: .1em;
  letter-spacing: .02em;
  line-height: 1.1;
}
.content {
  font-family: Droid Serif, PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei, sans-serif;
  line-height: 1.62;
  /* max-width: 700px; */
  /* margin: 60px auto; */
}
.entry-meta {
  margin-top: 60px;
  font-size: 14px;
  color: #9E9E9E;
}
.content img {
  max-width: 100%;
}
pre {
  padding: 10px;
  overflow: auto;
  border: #E3EDF3 1px solid;
  background: #F7FAFB;
}
</style><style type="text/css">
#social-media a {
  font-family: -apple-system;
  color: #8B572A;
}
#social-media a:hover {
  color: #733F10;
}
</style><style type="text/css">
textarea {
  width: 100%;
  height: 400px;
}
.h1 {
  font-size: 24px;
}
</style><style type="text/css">
#app {
  max-width: 1080px;
  margin: 0 auto;
}
#nav {
}
#social-media {
  margin: 6px;
  float: right;
}
#logo {
  
  height: 42px;
}
#header {
  margin: 80px auto;
  text-align: center;
  font-family: -apple-system, 'Helvetica Neue';
}
#header h1 {
  font-size: 38px;
  color: #333333;
}
#header p {
  font-size: 22px;
  color: #A9A9A9;
  -webkit-font-smoothing: antialiased;
}
.divider {
  height: 1px;
  background-color: #E6E6E6;
}
#post-list {
  max-width: 700px;
  margin: 80px auto;
  padding: 0;
}
#post-list li {
  list-style: none;
}
.write-button-container {
  max-width: 700px;
  margin: 0 auto;
  margin-top: 60px;
  text-align: right;
}
.button {
  padding: 8px 16px;
  border: 1px solid rgba(0, 0, 0, .25);
  border-radius: 4px;
  text-decoration: none;
  color: rgba(0, 0, 0, .25);
  font-family: sans-serif;
  font-size: 14px;
}
.button:hover {
  border: 1px solid rgba(0, 0, 0, .45);
  color: rgba(0, 0, 0, .45);
}
</style><style type="text/css">
input, textarea {
  border: none;
}
textarea {
  height: 50px;
}
.title {
  font-size: 20px;
  font-weight: bold;
}
.post-list a:hover {
  text-decoration: underline;
}
.post-list .date, .post-list .category-and-tags {
  font-size: 12px;
  color: #9E9E9E;
}
.post-list .summary {
  font-size: 14px;
  line-height: 24px;
  color: #333;   
  overflow-wrap: break-word;
}
.post-list-divider {
    margin: 30px auto;
}
.operation {
  cursor: pointer;
}
</style></head>
<body>
    <div id="app"><div id="nav"><a href="/" class="router-link-active"><img id="logo" src="/logo.svg"></a> <p id="social-media"><a href="https://twitter.com/olimovier">Twitter</a> / <a href="https://www.instagram.com/olimovier/">Instagram</a> / <a href="/feed.xml">RSS</a></p></div> <div class="view"><div class="entry-meta">Nov 04, 2015 #iOS #Objective-C #GIF</div> <h1 class="entry-title">iOS中使用UIScrollView实现图片滑动切页和轮播</h1> <div class="content"><p>半夜被老婆“揍了一顿”，“揍”得我咳嗽得厉害，一点儿都睡不着，干脆起来写篇文章吧！又是好久好久没更新博客了，之前刚用Ghost时的激动兴奋之情早已烟消云散，在Ghost平台下总共才写下了屈指可数的几篇文章，有的还不是原创，真是悲哀啊！</p>
<p>现在我正在用Atom写这篇文章，开启了Markdown实时预览，写作体验不比Ghost差。Atom开启Markdown实时预览时会碰到<a href="http://atom-china.org/t/soft-wrap/207">中文自动断行问题(Soft Wrap)</a>，可以使用AtomicChar插件解决。至于博客平台我也打算从Ghost迁移到Hexo，感觉Hexo还是挺炫酷的，最重要的是方便，无论是部署还是维护。</p>
<p>这是我在Hexo平台发布的第一篇文章。</p>
<hr>
<p>本文中我们要讨论的是如何在iOS中使用UIScrollView实现滑动切页和轮播，我们先实现滑动切页，滑动切页实现之后，轮播自然而然就有了。先看效果图：</p>
<p><img src="/images/view-pager-and-flipper-demo.gif" alt="最终效果图"></p>
<h3 id="-">思路</h3>
<p>如果我们有三张图片1、2、3，要求按照顺序实现滑动切页，那么应该为UIScrollView添加几个Subview呢？答案是五个。五个Subview的顺序应该是这样的：3，1，2，3，1。这样一来当我们从位置三滑到位置四时，显示的还是图片1，这时候我们神不知鬼不觉地把UIScrollView的偏移位置设置到位置一。当从位置一滑到位置零时同样如此，悄悄地把偏移量设置到位置三。其实思路还是非常简单的，如图所示，操作起来也不难。</p>
<p><img src="/images/view-flipper.png" alt="图示"></p>
<p>至于效果图下方的小圆点，我们就使用iOS自带的UIPageControl就可以了。其实在这里UIScrollView和UIPageControl并没有多大的关系，只要保证UIPageControl正确显示就可以了。</p>
<h3 id="-">代码</h3>
<p><em>首先</em>，你得有一个UIScrollView并设置相关属性：</p>
<pre><code class="lang-objc">// 设置UIScrollView的内容宽度 ＝ SubView的宽度 x Subview的数量
CGSize size = self.scrollView.contentSize;
size.width = self.width * [self.imageArray count];
self.scrollView.contentSize = size;
// 开启UIScrollView的翻页属性
self.scrollView.pagingEnabled = YES;
// 隐藏滑动栏
self.scrollView.showsHorizontalScrollIndicator = NO;
// 设置delegate
self.scrollView.delegate = self;
// 设置初始位置
self.scrollView.contentOffset = CGPointMake(self.width, 0);
</code></pre>
<p><em>其次</em>，为UIScrollView添加Subview：</p>
<pre><code class="lang-objc">for (int a = 0; a &lt; [self.imageArray count]; a++) {
    // 初始化每个Subview并设置其大小和位置
    UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(self.width * a, 0, self.view.bounds.size.width, 200)];
    imageView.image = [UIImage imageNamed:self.imageArray[a]];
    [self.scrollView addSubview:imageView];
}
</code></pre>
<p>顺便初始化一个UIPageControl：</p>
<pre><code class="lang-objc">// 设置pageControl的位置、大小、数量、默认颜色和当前页颜色
self.pageControl = [[UIPageControl alloc] init];
self.pageControl.center = CGPointMake(self.view.bounds.size.width * 0.5, self.scrollView.bounds.size.height - 10);
self.pageControl.bounds = CGRectMake(0, 0, 150, 50);
self.pageControl.numberOfPages = [self.imageArray count] - 2;
self.pageControl.pageIndicatorTintColor = [UIColor grayColor];
self.pageControl.currentPageIndicatorTintColor = [UIColor whiteColor];
self.pageControl.enabled = NO;
[self.view addSubview:self.pageControl];
</code></pre>
<p><em>最后</em>，覆写<code>scrollViewDidEndDecelerating</code>方法：</p>
<pre><code class="lang-objc">- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView {
    // 计算当前位置
    int currentPage = self.scrollView.contentOffset.x / self.view.bounds.size.width;

    // 按照思路在特殊位置使用setContentOffset方法设置UIScrollView的偏移量
    // animated参数一定要设为NO，因为是‘悄悄地’，不能引起用户注意
    // pageControl的currentPage一起设置下
    if (currentPage == 0) {
        [self.scrollView setContentOffset:CGPointMake(self.width*([self.imageArray count] -2), 0) animated:NO];
        self.pageControl.currentPage = [self.imageArray count] - 3;
    } else if (currentPage==[self.imageArray count] - 1) {
        [self.scrollView setContentOffset:CGPointMake(self.width, 0) animated:NO];
        self.pageControl.currentPage = 0;
    } else {
        self.pageControl.currentPage = currentPage - 1;
    }
}
</code></pre>
<p>到这里，我们已经实现了滑动切页的功能，接下去我们使用定时器实现轮播效果。启动一个定时器的代码差不多长这个样子：</p>
<pre><code class="lang-objc">[NSTimer scheduledTimerWithTimeInterval:3 target:self selector:@selector(runTimePage) userInfo:nil repeats:YES];
</code></pre>
<p><code>runTimePage</code>方法自然不能少：</p>
<pre><code class="lang-objc">- (void)runTimePage {
    long lastPage = self.pageControl.currentPage;

    // 当上次处于最后一张图片时，这次应该到第一张图片去了
    if (lastPage == [self.imageArray count] - 3) {
        self.pageControl.currentPage = 0;
        [self.scrollView setContentOffset:CGPointMake(self.width, 0) animated:NO];
    } else {
        self.pageControl.currentPage = lastPage + 1;
        [self.scrollView setContentOffset:CGPointMake(self.width * (self.pageControl.currentPage + 1), 0) animated:NO];
    }
}
</code></pre>
<p>这样一来，轮播的功能也实现了。</p>
<h3 id="-">优化</h3>
<p>现在，滑动切页和轮播功能都实现了，他们单独使用都没有问题，但是一旦把它们放在一起，你就会发现在滑动切页时会有一种凌乱的感觉，那是因为计时器一直在不停地工作。这种情况下，用户的操作体验是非常糟糕的。我们希望当用户开始滑动切页时，停止轮播，即计时器暂停工作，当切页结束后，开启轮播，即计时器开始工作。</p>
<p>无论是暂停启动器还是启动启动器，都可以使用<code>NSTimer</code>的<code>setFireDate</code>方法，只要设置正确的参数就行了。</p>
<p>当滑动切页开始时，暂停计时器：</p>
<pre><code class="lang-objc">- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView {
    // 将启动时间设置为很遥远的未来，于是计时器暂停了
    [self.timer setFireDate:[NSDate distantFuture]];
}
</code></pre>
<p>当滑动切页结束后，启动计时器：</p>
<pre><code class="lang-objc">- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView {
    ...
    // 启动时间一定要设置在现在后的某一刻，这里我设置成三秒后启动
    // 如果设置成现在的话，runTimePage会立即执行，会马上跳到下一张图片，就不对了
    NSDate *date = [[NSDate date] dateByAddingTimeInterval:3];
    // 启动计时器
    [self.timer setFireDate:date];
}
</code></pre>
<p>终于，整个滑动切页和轮播变得如丝般顺滑了。完整的代码可以在我的<a href="https://github.com/movier/learn-ios/blob/master/learn-ios/PagerAndFlipperViewController.m">Github</a>上找到。</p>
</div> <input type="hidden" id="loaded-signal"></div> <p class="copyright">Copyright © 2017 MOVIER.ME - All Rights Reserved.</p></div>
  


</body></html>