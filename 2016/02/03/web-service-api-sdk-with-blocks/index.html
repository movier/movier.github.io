<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <!-- Use 使用Blocks封装Web Service API for dynamic title -->
 <title>OLIVER</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <!-- Twitter bootstrap (via cdn) -->
 <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"> -->
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/font-awesome-4.5.0/css/font-awesome.min.css">
</head>
<body>
  <!-- <div class='container'> -->
    <ul class="main-navigation">
  
    
      <li><a href="/"><u>Home</u></a></li>
    
  
    
      <li><a href="/blog"><u>Blog</u></a></li>
    
  
    
  
    
  
</ul>

<div class="container">
<div class="post-detail">
<div class='entry'>
  <div class='entry-header'>
    <h1 class="title">使用Blocks封装Web Service API</h1>
    <footer class="entry-meta">发布于 2016-02-03。属于
      技术
      分类，被贴了
      iOS、Objective-C、Blocks、Swift、Closures
      标签。</footer>
  </div>
  <p>《嘻嘻圈》作为一款互联网应用，涉及到许多网络操作。在开发初期，为了追求进度，简单粗暴的在需要的时候发起连接请求。这样一来，造成了很多重复代码。这个问题在我开始写相关代码的时候就意识到了。我之所以迟迟没有优化是因为网络操作都是异步的，需要等待处理结果，然后根据结果写相关代码。重复或者说需要优化的代码在外部，自定义代码在回调结果里，使用一般的代码优化办法不可行。当时我就在想我的自定义代码如果可以作为一个函数的参数就好了，这样就可以成功地优化代码了。那时候我还不知道怎么办，直到最近几天读到objective-c中block的相关内容时，我才恍然大悟，block不就是我期盼的东西吗!</p>
<a id="more"></a>
<p>举个例子，我可能需要像下面这样使用<code>NSURLSession</code>发起多个Get请求，我之前的做法是在每个需要发起Get请求的地方都复制一份以下的代码，只不过将url和completionHandler的实现替换成实际的需求。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://movier.me"</span>]; <span class="comment">//重复代码，只不过url不同</span></span><br><span class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:URL]; <span class="comment">// 重复代码</span></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *task = [[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123; <span class="comment">// 重复代码</span></span><br><span class="line">    <span class="comment">/* 以下这些代码可能会不同</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *html = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span><br><span class="line">    [self.webView loadHTMLString:html baseURL:URL];</span><br><span class="line">     */</span></span><br><span class="line">&#125;];</span><br><span class="line">[task resume]; <span class="comment">// 重复代码</span></span><br></pre></td></tr></table></figure></p>
<p>这样做显然会造成许多重复的代码，如果能把completionHandler中的代码片段当成一个参数传人我们提炼的方法中的话，就能成功地优化代码了。而<code>Blocks</code>正是实现这个功能的完美解决方案。</p>
<p><strong>What’s Blocks?</strong></p>
<blockquote>
<p>Blocks are a language-level feature added to C, Objective-C and C++, which allow you to create distinct segments of code that can be passed around to methods or functions as if they were values.</p>
<p>Blocks是加入到C、Objective-C和C++语言层面的特点，它允许你创建不同的代码片段，而这些代码片段可以作为参数传递给方法或者函数就好像他们是数值一样。</p>
</blockquote>
<p><strong>使用Blocks解决上述问题</strong></p>
<p>首先，定义方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)methodNameUrl:(<span class="built_in">NSString</span> *)url callback:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *, <span class="built_in">NSError</span> *))callback;</span><br></pre></td></tr></table></figure></p>
<p>其次，实现该方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)methodNameUrl:(<span class="built_in">NSString</span> *)url callback:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *, <span class="built_in">NSError</span> *))callback &#123;</span><br><span class="line">  <span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:url];</span><br><span class="line">  <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:URL];</span><br><span class="line">  <span class="built_in">NSURLSessionDataTask</span> *task = [[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    callback(data, error);</span><br><span class="line">  &#125;];</span><br><span class="line">  [task resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，只要在需要的地方调用该方法并传入相应参数即可：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">id</span> methodNameUrl:<span class="string">@"http://movier.me"</span> callback:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">  <span class="comment">// Do whatever you want to do</span></span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">NSString</span> *html = [[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">  [<span class="keyword">self</span>.webView loadHTMLString:html baseURL:URL];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>这样一来，我们就成功地使用Blocks优化了代码。其实，除了Objective-C之外，其他语言也有类似特性，譬如Swift的Closures，Java 8中的Lambdas等。</p>
<p><strong>接下去，我们尝试使用Swift的Closures实现上述需求</strong></p>
<p>首先，还是定义方法：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">methodNameUrl</span><span class="params">(url: String, completionClosure: <span class="params">(data: NSData?, error: NSError?)</span></span></span> -&gt; ()) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="type">NSURL</span>(string: url)</span><br><span class="line">    <span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>: url!)</span><br><span class="line">    <span class="keyword">let</span> task = <span class="type">NSURLSession</span>.sharedSession().dataTaskWithRequest(request, completionHandler: &#123;(data, response, error) <span class="keyword">in</span></span><br><span class="line">      completionClosure(data: data, error: error)</span><br><span class="line">    &#125;)</span><br><span class="line">    task.resume()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后，调用该方法并传入相应参数即可：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">methodNameUrl<span class="function"><span class="params">(<span class="string">"http://httpbin.org/get"</span>)</span> &#123; <span class="params">(data, error)</span> -&gt;</span> () <span class="keyword">in</span></span><br><span class="line">    <span class="regexp">// Do something with data or error</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>至此，我们分别使用Objective-C的Blocks和Swift的Closures封装了Web Service API。</p>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="https://www.gitbook.com/book/zonble/kkbox-ios-dev/details" target="_blank" rel="external">KKBOX iOS/Mac OS X 基本開發教材</a>中关于Blocks的章节</li>
<li>感谢<a href="http://httpbin.org" target="_blank" rel="external">httpbin</a>提供的免费调试服务</li>
</ul>

</div>
</div>
</div>
<div class="footer">
  <p class="align-left"><i>Powered by <a href="https://hexo.io"><u>Hexo</u></a> Theme by <a href="https://github.com/movier/hexo-theme-alpha"><u>Alpha</u></a></i></p>
  <p class="align-right">Copyright © 2016 movier.me</p>
  <div style="clear: both;"></div>
</div>


    <!-- <div class="footer">
  <p class="align-left"><i>Powered by <a href="https://hexo.io"><u>Hexo</u></a> Theme by <a href="https://github.com/movier/hexo-theme-alpha"><u>Alpha</u></a></i></p>
  <p class="align-right">Copyright © 2016 movier.me</p>
  <div style="clear: both;"></div>
</div>
 -->
  <!-- </div> -->
</body>
</html>
